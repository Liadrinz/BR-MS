<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>后勤物资查询调配</title>
    <link rel="stylesheet" href="lib/eleme-index.css">
    <style>
        .el-form-item {
            margin: 0;
        }

        .postfix {
            color: #8c939d;
            font-size: 13px;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div>
        <el-form>
            <el-form-item label="物资状态：" size="mini">
                <el-radio-group v-model="stateId" :disabled="tempVisible">
                    <el-radio :label="null" border>不限</el-radio>
                    <el-radio :label="1" border>占用</el-radio>
                    <el-radio :label="2" border>调配</el-radio>
                    <el-radio :label="3" border>使用</el-radio>
                    <el-radio :label="4" border>空闲</el-radio>
                </el-radio-group>
            </el-form-item>
            <el-form-item label="物资类别：" size="mini">
                <el-select v-model="type" placeholder="物资类型" :disabled="tempVisible">
                    <el-option :value="undefined">不限</el-option>
                    <el-option value="电脑整机">电脑整机</el-option>
                    <el-option value="大型家电">大型家电</el-option>
                    <el-option value="网络产品">网络产品</el-option>
                    <el-option value="厨房电器">厨房电器</el-option>
                    <el-option value="电脑配件">电脑配件</el-option>
                    <el-option value="五金装饰">五金装饰</el-option>
                    <el-option value="摄影摄像">摄影摄像</el-option>
                    <el-option value="健康卫生">健康卫生</el-option>
                    <el-option value="数码配件">数码配件</el-option>
                    <el-option value="通信器材">通信器材</el-option>
                    <el-option value="办公设备">办公设备</el-option>
                    <el-option value="家具">家具</el-option>
                    <el-option value="文具耗材">文具耗材</el-option>
                    <el-option value="生活电器">生活电器</el-option>
                    <el-option value="生活用品">生活用品</el-option>
                    <el-option value="汽车用品">汽车用品</el-option>
                    <el-option value="文体器材">文体器材</el-option>
                    <el-option value="学习书籍">学习书籍</el-option>
                    <el-option value="粮油食品">粮油食品</el-option>
                    <el-option value="工程建材">工程建材</el-option>
                    <el-option value="医疗卫生">医疗卫生</el-option>
                    <el-option value="油品">油品</el-option>
                    <el-option value="军队服装">军队服装</el-option>
                    <el-option value="交通工具">交通工具</el-option>
                    <el-option value="其他">其他</el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="地理位置：" size="mini">
                <el-radio v-model="locationRadio" label="1" @change="(val)=>{
                if(val==='1'){
                    while(selectedLocations[0]!==undefined){
                        selectedLocations.pop();
                    }
                }
            }" :disabled="tempVisible" border>不限
                </el-radio>
                <el-cascader :options="areaData" v-model="selectedLocations"
                             @change="handleChange" :disabled="tempVisible"></el-cascader>
            </el-form-item>
            <el-form-item label="生产日期：" size="mini">
                <el-date-picker v-model="produceTime" type="date" placeholder="选择日期" format="yyyy年MM月dd日"
                                value-format="yyyy-MM-dd" :disabled="tempVisible"></el-date-picker>
                <span>后</span>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="search" :disabled="tempVisible">查询</el-button>
                <el-button @click="reset" :disabled="tempVisible">重置</el-button>
                <el-button type="success" @click="viewTemp">{{tempVisible?'返回':'查看暂存申请'}}</el-button>
            </el-form-item>
        </el-form>
        <div v-show="!tempVisible">
            <!--  查询结果 Table  -->
            <el-table
                ref="multipleTable" :data="resultData"
                tooltip-effect="dark" stripe
                @selection-change="handleSelectionChange">
                <el-table-column type="selection" width="55"></el-table-column>
                <el-table-column type="index" :index="indexMethod" label="序号"></el-table-column>
                <el-table-column prop="localId" label="物资编号"></el-table-column>
                <el-table-column prop="goodsName" label="物资名称"></el-table-column>
                <el-table-column prop="producerName" label="生产厂商"></el-table-column><!--无接口名-->
                <el-table-column prop="norms" label="规格"></el-table-column>            <!--无接口名-->
                <el-table-column prop="warehouseName" label="所在仓库"></el-table-column>
                <el-table-column prop="quantity" label="库存数量"></el-table-column>   <!--无接口名-->
                <el-table-column prop="address" label="仓库地址"></el-table-column>     <!--无接口名-->
                <el-table-column prop="state" label="状态"></el-table-column>          <!--无接口名-->
                <el-table-column label="" width="200">
                    <template slot-scope="props">
                        <el-button size="mini" type="text" @click="()=>{detail(props.row)}">详情</el-button>
                        <el-button size="mini" type="text" @click="()=>{allocate(props.row)}">申请调配</el-button>
                        <el-dialog title="申请信息" :visible.sync="props.row.dialogVisible" width="70%"
                                   :before-close="()=>{props.row.dialogVisible=false;clearFilledForm();}">
                            <!--申请信息表单-->
                            <el-form>
                                <el-form :inline="true" :rules="applyRules.rule1" :model="singleForm">
                                    <el-form-item label="申请人" size="mini">
                                        <el-input v-model="singleForm.userRealName" :disabled="true"></el-input>
                                    </el-form-item>
                                    <el-form-item label="申请单位" size="mini">
                                        <el-input v-model="singleForm.companyName" :disabled="true"></el-input>
                                    </el-form-item>
                                </el-form>

                                <!--可删除表单-->  <!--?如何多选时生成相应数量的此表单-->
                                <el-form>
                                    <el-form :inline="true" :rules="applyRules.rule2" :model="singleForm"><!--从后台生成-->
                                        <el-form-item label="申请物资名称" size="mini">
                                            <el-input v-model="singleForm.goodName" :disabled="true"></el-input>
                                        </el-form-item>
                                        <el-form-item label="申请物资ID" size="mini">
                                            <el-input v-model="singleForm.goodId" :disabled="true"></el-input>
                                        </el-form-item>
                                        <el-form-item label="所在仓库" size="mini">
                                            <el-input v-model="singleForm.startWarehouseName"
                                                      :disabled="true"></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule3" ref="form1" :model="singleForm">
                                        <!--可清空Input输入框-->
                                        <el-form-item label="用途说明" size="mini" prop="description" required>
                                            <el-input v-model="singleForm.description" clearable></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule4" ref="form2" :model="singleForm">
                                        <el-form-item label="调配数量" size="mini" prop="amount" required>
                                            <el-input v-model="singleForm.amount" clearable></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule0" ref="form3" :model="singleForm">
                                        <el-form-item label="预计调配时间" size="mini">
                                            <el-input v-model="singleForm.time" :disabled="true"
                                                      style="width: 150px"></el-input>
                                            <span class="postfix">小时</span>
                                        </el-form-item>
                                        <el-form-item label="需求类型" size="mini" prop="transport" required>
                                            <el-select v-model="singleForm.transport" @change="()=>{
                                                singleForm.time=360/singleForm.transport;
                                                }">
                                                <el-option label="应急" :value="20"></el-option>
                                                <el-option label="普通" :value="4"></el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="期望时间成本" size="mini" prop="expectTime" required>
                                            <el-select v-model="singleForm.expectTime">
                                                <el-option label="高" value="高"></el-option>
                                                <el-option label="中" value="中"></el-option>
                                                <el-option label="低" value="低"></el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-form>
                                </el-form>

                                <!--目的地地址 目的仓库-->
                                <el-form :inline="true" :rules="applyRules.rule7" ref="form4" :model="{
                            address:selectedLocations,
                            detailA:singleForm.destinationAddress
                        }">
                                    <el-form-item label="目的省市：" size="mini" prop="address" required>
                                        <el-cascader :options="areaData" v-model="selectedLocations"
                                                     @change="handleChange"></el-cascader>
                                    </el-form-item>
                                    <el-form-item label="详细地址：" size="mini" prop="detailA" required>
                                        <el-input v-model="singleForm.destinationAddress"></el-input>
                                    </el-form-item>
                                    <el-form :rules="applyRules.rule71" ref="form41" :model="singleForm">
                                        <el-form-item label="目的仓库" size="mini" prop="endWarehouseName" required>
                                            <el-select v-model="singleForm.endWarehouseName" clearable>
                                                <el-option v-for="warehouse in warehouseChoice"
                                                           :value="warehouse.warehouseName"
                                                           :label="warehouse.warehouseName">
                                                    {{warehouse.warehouseName}}
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-form>
                                </el-form>
                                <hr>
                            </el-form>
                            <el-form>
                                <!--联系人 联系电话 备注-->
                                <el-form :inline="true" :rules="applyRules.ruleB" ref="form5" :model="singleForm">
                                    <!--如果联系人就是申请人的话 否则没有接口名-->
                                    <p>
                                        <el-form-item label="联系人" size="mini" prop="userRealName" required>
                                            <el-input v-model="singleForm.userRealName" clearable></el-input>
                                        </el-form-item>
                                    </p>
                                    <p>
                                        <el-form-item label="联系电话" size="mini" prop="tel" required>
                                            <el-input v-model="singleForm.tel" clearable></el-input>
                                        </el-form-item>
                                    </p>
                                    <p>
                                        <el-form-item label="备注" size="mini" prop="ps" required>
                                            <el-input v-model="singleForm.ps" :rows="3" placeholder="请输入备注"
                                                      clearable></el-input>
                                        </el-form-item>
                                    </p>
                                </el-form>
                            </el-form>

                            <span slot="footer" class="dialog-footer">
            <el-button size="mini" @click="()=>{submitSingle(props.row,'temp')}">暂存</el-button>
            <el-button size="mini" @click="()=>{submitSingle(props.row)}">提交</el-button>
            <el-button @click="()=>{props.row.dialogVisible=false;clearFilledForm();}" size="mini">返回</el-button>
        </span>
                        </el-dialog>
                    </template>
                </el-table-column>
            </el-table>
            <p style="text-align: center">
                <el-pagination @current-change="handleCurrentChange" :current-page="pageNum"
                               :page-size="6" layout="total,prev,pager,next,jumper" :total="totalNum"></el-pagination>
            </p>
            <div>
                <el-button size="mini" @click="allocateAll">申请调配所选项</el-button>
            </div>
        </div>

        <div v-show="tempVisible">
            <el-table
                ref="multipleTable2" :data="resultData2"
                tooltip-effect="dark" stripe
                @selection-change="handleSelectionChange2">
                <el-table-column type="selection" width="55"></el-table-column>
                <el-table-column prop="goodsId" label="物资编号"></el-table-column>
                <el-table-column prop="goodsName" label="物资名称"></el-table-column>
                <el-table-column prop="startWarehouseName" label="所在仓库"></el-table-column>
                <el-table-column label="" width="200">
                    <template slot-scope="props">
                        <el-button size="mini" type="text" @click="()=>{allocate(props.row,'frtmp')}">编辑</el-button>
                        <el-button size="mini" type="text" @click="()=>{delTemp(props.row)}">删除</el-button>
                        <el-dialog title="申请信息" :visible.sync="props.row.dialogVisible" width="70%"
                                   :before-close="()=>{props.row.dialogVisible=false;clearFilledForm();}">
                            <!--申请信息表单-->
                            <el-form>
                                <el-form :inline="true" :rules="applyRules.rule1" :model="singleForm">
                                    <el-form-item label="申请人" size="mini">
                                        <el-input v-model="singleForm.userRealName" :disabled="true"></el-input>
                                    </el-form-item>
                                    <el-form-item label="申请单位" size="mini">
                                        <el-input v-model="singleForm.companyName" :disabled="true"></el-input>
                                    </el-form-item>
                                </el-form>

                                <!--可删除表单-->  <!--?如何多选时生成相应数量的此表单-->
                                <el-form>
                                    <el-form :inline="true" :rules="applyRules.rule2" :model="singleForm"><!--从后台生成-->
                                        <el-form-item label="申请物资名称" size="mini">
                                            <el-input v-model="singleForm.goodName" :disabled="true"></el-input>
                                        </el-form-item>
                                        <el-form-item label="申请物资ID" size="mini">
                                            <el-input v-model="singleForm.goodId" :disabled="true"></el-input>
                                        </el-form-item>
                                        <el-form-item label="所在仓库" size="mini">
                                            <el-input v-model="singleForm.startWarehouseName"
                                                      :disabled="true"></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule3" ref="form1" :model="singleForm">
                                        <!--可清空Input输入框-->
                                        <el-form-item label="用途说明" size="mini" prop="description" required>
                                            <el-input v-model="singleForm.description" clearable></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule4" ref="form2" :model="singleForm">
                                        <el-form-item label="调配数量" size="mini" prop="amount" required>
                                            <el-input v-model="singleForm.amount" clearable></el-input>
                                        </el-form-item>
                                    </el-form>
                                    <el-form :inline="true" :rules="applyRules.rule0" ref="form3" :model="singleForm">
                                        <el-form-item label="预计调配时间" size="mini">
                                            <el-input v-model="singleForm.time" :disabled="true"
                                                      style="width: 150px"></el-input>
                                            <span class="postfix">小时</span>
                                        </el-form-item>
                                        <el-form-item label="需求类型" size="mini" prop="transport" required>
                                            <el-select v-model="singleForm.transport" @change="()=>{
                                                singleForm.time=360/singleForm.transport;
                                                }">
                                                <el-option label="应急" :value="20"></el-option>
                                                <el-option label="普通" :value="4"></el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="期望时间成本" size="mini" prop="expectTime" required>
                                            <el-select v-model="singleForm.expectTime">
                                                <el-option label="高" value="高"></el-option>
                                                <el-option label="中" value="中"></el-option>
                                                <el-option label="低" value="低"></el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-form>
                                </el-form>

                                <!--目的地地址 目的仓库-->
                                <el-form :inline="true" :rules="applyRules.rule7" ref="form4" :model="{
                            address:selectedLocations,
                            detailA:singleForm.destinationAddress
                        }">
                                    <el-form-item label="目的省市：" size="mini" prop="address" required>
                                        <el-cascader :options="areaData" v-model="selectedLocations"
                                                     @change="handleChange"></el-cascader>
                                    </el-form-item>
                                    <el-form-item label="详细地址：" size="mini" prop="detailA" required>
                                        <el-input v-model="singleForm.destinationAddress"></el-input>
                                    </el-form-item>
                                    <el-form :rules="applyRules.rule71" ref="form41" :model="singleForm">
                                        <el-form-item label="目的仓库" size="mini" prop="endWarehouseName" required>
                                            <el-select v-model="singleForm.endWarehouseName" clearable>
                                                <el-option v-for="warehouse in warehouseChoice"
                                                           :value="warehouse.warehouseName"
                                                           :label="warehouse.warehouseName">
                                                    {{warehouse.warehouseName}}
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-form>
                                </el-form>
                                <hr>
                            </el-form>
                            <el-form>
                                <!--联系人 联系电话 备注-->
                                <el-form :inline="true" :rules="applyRules.ruleB" ref="form5" :model="singleForm">
                                    <!--如果联系人就是申请人的话 否则没有接口名-->
                                    <p>
                                        <el-form-item label="联系人" size="mini" prop="userRealName" required>
                                            <el-input v-model="singleForm.userRealName" clearable></el-input>
                                        </el-form-item>
                                    </p>
                                    <p>
                                        <el-form-item label="联系电话" size="mini" prop="tel" required>
                                            <el-input v-model="singleForm.tel" clearable></el-input>
                                        </el-form-item>
                                    </p>
                                    <p>
                                        <el-form-item label="备注" size="mini" prop="ps" required>
                                            <el-input v-model="singleForm.ps" :rows="3" placeholder="请输入备注"
                                                      clearable></el-input>
                                        </el-form-item>
                                    </p>
                                </el-form>
                            </el-form>

                            <span slot="footer" class="dialog-footer">
            <el-button size="mini" @click="()=>{submitSingle(props.row,'temp','frtmp')}">暂存</el-button>
            <el-button size="mini" @click="()=>{submitSingle(props.row,'','frtmp')}">提交</el-button>
            <el-button @click="()=>{props.row.dialogVisible=false;clearFilledForm();}" size="mini">返回</el-button>
        </span>
                        </el-dialog>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <!-- 与物资详情、申请物资有关的对话框 -->
        <el-dialog title="物资详情" :visible.sync="dialogs.detail" width="98%">
            <el-table :data="detailForm">
                <el-table-column prop="key1" :width="150">
                    <template slot-scope="props">
                        <b>{{props.row.key1}}</b>
                    </template>
                </el-table-column>
                <el-table-column prop="val1" :width="200">
                    <template slot-scope="props">
                        <p style="margin: 0;">{{props.row.val1}}</p>
                    </template>
                </el-table-column>
                <el-table-column prop="key2" :width="150">
                    <template slot-scope="props">
                        <b>{{props.row.key2}}</b>
                    </template>
                </el-table-column>
                <el-table-column prop="val2" :width="275">
                    <template slot-scope="props">
                        <p style="margin: 0;">{{props.row.val2}}</p>
                    </template>
                </el-table-column>
                <el-table-column prop="key3" :width="150">
                    <template slot-scope="props">
                        <b>{{props.row.key3}}</b>
                    </template>
                </el-table-column>
                <el-table-column prop="val3" :width="220">
                    <template slot-scope="props">
                        <p style="margin: 0;">{{props.row.val3}}</p>
                    </template>
                </el-table-column>
            </el-table>
            <span slot="footer" class="dialog-footer">
            <el-button @click="dialogs.detail=false" size="mini">关闭</el-button>
        </span>
        </el-dialog>
        <el-dialog title="申请信息" :visible.sync="dialogs.allocateAll" width="70%">
            <!--申请信息表单-->
            <div v-for="i in (()=>{
            var arr=[];
            for(var i of multipleSelection.keys()){
            arr.push(i);
            }
            return arr;
            })()">
                <el-form>
                    <el-form :inline="true" :rules="applyRules.rule1" :model="singleForm">
                        <el-form-item label="申请人" size="mini">
                            <el-input v-model="singleForm.userRealName" :disabled="true"></el-input>
                        </el-form-item>
                        <el-form-item label="申请单位" size="mini">
                            <el-input v-model="singleForm.companyName" :disabled="true"></el-input>
                        </el-form-item>
                    </el-form>

                    <!--可删除表单-->  <!--?如何多选时生成相应数量的此表单-->
                    <el-form>
                        <el-form :inline="true" :rules="applyRules.rule2" :model="applicationForm[i]"><!--从后台生成-->
                            <el-form-item label="申请物资名称" size="mini">
                                <el-input v-model="applicationForm[i].goodName" :disabled="true"></el-input>
                            </el-form-item>
                            <el-form-item label="申请物资ID" size="mini">
                                <el-input v-model="applicationForm[i].goodId" :disabled="true"></el-input>
                            </el-form-item>
                            <el-form-item label="所在仓库" size="mini">
                                <el-input v-model="applicationForm[i].startWarehouseName"
                                          :disabled="true"></el-input>
                            </el-form-item>
                        </el-form>
                        <el-form :inline="true" :rules="applyRules.rule3" ref="form6" :model="applicationForm[i]">
                            <!--可清空Input输入框-->
                            <el-form-item label="用途说明" size="mini" prop="description" required>
                                <el-input v-model="applicationForm[i].description" clearable></el-input>
                            </el-form-item>
                        </el-form>
                        <el-form :inline="true" :rules="applyRules.rule4" ref="form7" :model="applicationForm[i]">
                            <el-form-item label="调配数量" size="mini" prop="amount" required>
                                <el-input v-model="applicationForm[i].amount" clearable></el-input>
                            </el-form-item>
                        </el-form>
                        <el-form :inline="true">
                            <el-form-item label="预计调配时间" size="mini"><!--无对应接口名-->
                                <el-input v-model="applicationForm[i].time" :disabled="true"
                                          style="width: 150px"></el-input>
                                <span class="postfix">小时</span>
                            </el-form-item>
                            <el-form :rules="applyRules.rule5" ref="form8" :model="applicationForm[i]">
                                <el-form-item label="需求类型" size="mini" prop="transport" required><!--无对应接口名-->
                                    <el-select v-model="selectedTransport[i]" @change="()=>{
                                applicationForm[i].transport=selectedTransport[i];
                                applicationForm[i].time=360/selectedTransport[i];
                            }">
                                        <el-option label="应急" :value="20"></el-option>
                                        <el-option label="普通" :value="4"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-form>
                            <el-form :rules="applyRules.rule6" ref="form9" :model="applicationForm[i]">
                                <el-form-item label="期望时间成本" size="mini" prop="expectTime" required>
                                    <el-select v-model="selectedExpectTime[i]"
                                               @change="(value)=>{applicationForm[i].expectTime=value;}">
                                        <el-option label="高" value="高"></el-option>
                                        <el-option label="中" value="中"></el-option>
                                        <el-option label="低" value="低"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-form>

                        </el-form>
                    </el-form>

                    <!--目的地地址 目的仓库-->
                    <el-form :inline="true" :rules="applyRules.rule7" ref="form10" :model="applicationForm[i]">
                        <el-form-item label="省市：" size="mini" prop="destinationProvince" required>
                            <el-cascader :options="areaData" v-model="selectedLocationsList[i]"
                                         @change="()=>{
                                     handleChange();
                                     applicationForm[i].destinationProvince=selectedLocationsList[i][0];
                                     applicationForm[i].destinationAddress=selectedLocationList[i];
                                     }"></el-cascader>
                        </el-form-item>
                        <el-form-item size="mini" prop="destinationAddress" required>
                            <el-input v-model="applicationForm[i].destinationAddress" @change="()=>{

                        }"></el-input>
                        </el-form-item>
                    </el-form>
                    <el-form :inline="true" :rules="applyRules.rule8" ref="form11" :model="applicationForm[i]">
                        <el-form-item label="目的仓库" size="mini" prop="endWarehouseName" required>
                            <el-select v-model="selectedWarehouse[i]" @change="()=>{
                        applicationForm[i].endWarehouseName=selectedWarehouse[i]
                        }" clearable>
                                <el-option v-for="warehouse in warehouseChoiceList[i]" :value="warehouse.warehouseId"
                                           :label="warehouse.warehouseName">
                                    {{warehouse.warehouseName}}
                                </el-option>
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <hr>
                </el-form>
            </div>
            <el-form>
                <!--联系人 联系电话 备注-->
                <el-form :inline="true" :rules="applyRules.ruleB" ref="form12" :model="singleForm">
                    <!--如果联系人就是申请人的话 否则没有接口名-->
                    <p>
                        <el-form-item label="联系人" size="mini" prop="userRealName" required>
                            <el-input v-model="singleForm.userRealName" clearable></el-input>
                        </el-form-item>
                    </p>
                    <p>
                        <el-form-item label="联系电话" size="mini" prop="tel" required>
                            <el-input v-model="singleForm.tel" clearable></el-input>
                        </el-form-item>
                    </p>
                    <p>
                        <el-form-item label="备注" size="mini" prop="ps" required>
                            <el-input v-model="singleForm.ps" :rows="3" placeholder="请输入备注"
                                      clearable></el-input>
                        </el-form-item>
                    </p>
                </el-form>
            </el-form>
            <span slot="footer" class="dialog-footer">
            <el-button size="mini" @click="()=>{SubmitAll('temp')}">暂存</el-button>
            <el-button size="mini" @click="()=>{submitAll()}">提交</el-button>
            <el-button @click="()=>{dialogs.allocateAll=false;clearFilledForm();}" size="mini">返回</el-button>
        </span>
        </el-dialog>
    </div>
</div>
</body>
<script src="lib/vue.js"></script>
<script src="lib/eleme-index.js"></script>
<script src="res/dependencies.js"></script>
<script>
    //交互没写
    var post = require('/mods/backend');
    var CTT = require('element-china-area-data').CodeToText;
    var searchKey = {};
    var items = [];
    var pageNum = 1, pageSize = 6, maxPage = 0;
    var userInfo;
    var currentRow;

    const ChinaAreaData = require('element-china-area-data').provinceAndCityData;

    function getData(searchKey) {
        clearData();
        post('/common/user_goods/query', searchKey, (data, err) => {
            console.log(data);
            if (err) {
                app.$message.error(err.msg);
                return;
            }
            //TODO
            app.totalNum = data.totalNum;
            for (var i in data.overview) {
                data.overview[i]['dialogVisible'] = false;
                items.push(data.overview[i]);
            }
        })
    }

    function clearData() {
        while (items[0] !== undefined) {
            items.pop();
        }
    }


    var generalApplicationForm = {
        userRealName: "",
        companyName: "",
        goodName: "",
        goodId: "",
        startWarehouseName: "",
        description: "",
        amount: "",
        time: "",
        price: "",
        transport: "",
        expectTime: "",
        province: "",
        city: "",
        county: "",
        destinationAddress: "",
        endWarehouseName: "",
        tel: "",
        ps: ""
    }

    // var generalList = [{...generalApplicationForm}, {...generalApplicationForm}, {...generalApplicationForm},
    //     {...generalApplicationForm}, {...generalApplicationForm}, {...generalApplicationForm}];

    var generalList = [];
    for (let i = 0; i < 6; i++) {
        let obj = {};
        Object.assign(obj, generalApplicationForm);
        generalList.push(obj);
    }

    var app = new Vue({
        el: '#app',
        data: {
            tempVisible: false,
            pageNum: 1,
            totalNum: 0,
            stateId: '',
            locationRadio: '', /* 3.地理位置不限locationRadio */
            type: '',
            produceTime: '',
            selectedLocations: [],
            selectedLocationsList: [
                [], [], [], [], [], []
            ],
            warehouseChoice: [],
            warehouseChoiceList: [
                [], [], [], [], [], []
            ],
            selectedTransport: [],
            selectedExpectTime: [],
            selectedWarehouse: [],
            multipleSelection: [],
            multipleSelection2: [],
            areaData: ChinaAreaData,
            dialogs: {
                detail: false,
                allocate: false,
                allocateAll: false
            },
            resultData: items,
            resultData2: [],
            detailForm: [],
            applicationForm: generalList,
            singleForm: generalApplicationForm,
            transfer: {
                goods_id: '物资ID',
                goods_name: '物资名称',
                local_id: '编号',
                type: '物资类型',
                keywords: '关键字',
                norms: '规格',
                appearance: '外观',
                time_feature: '时间特征',
                safety_condition: '安全条件',
                carrier_size: '运载尺寸',
                temperature: '温度条件',
                humidity: '湿度条件',
                other_conditions: '其他条件',
                producer_name: '生产商',
                produce_time: '生产时间',
                produce_valid_time: '过期时间',
                warehouse_id: '所在仓库',
                longitude: '经度',
                latitude: '纬度',
                altitude: '海拔',
                country_id: '国家',
                area: '战区',
                province_id: '省份',
                city_id: '城市',
                county_id: '区县',
                detail_location: '详细地址',
                is_managed: '过程管理',
                register_time: '最后一次修改时间',
                state_id: '状态',
                state_type: '状态类型',
                state_value: '状态值',
                quantity: '数量'
            },
            applyRules: {
                rule0: {
                    transport: {required: true, message: '请选择需求类型'},
                    expectTime: {required: true, message: '请选择期望时间成本'}
                },
                rule3: {
                    description: {required: true, message: '请输入描述'},
                    amount: {required: true, message: '请输入数量'},
                },
                rule4: {
                    amount: {required: true, message: '请输入数量'}
                },
                rule5: {
                    p: {required: true, message: '请选择需求类型'}
                },
                rule6: {
                    p: {required: true, message: '请选择期望时间成本'}
                },
                rule7: {
                    address: {required: true, message: '请选择省市区'},
                    detailA: {required: true, message: '请填写详细地址'},
                },
                rule71: {
                    endWarehouseName: {required: true, message: '请选择目的仓库'}
                },
                rule8: {
                    p: {required: true, message: '请选择目的仓库'}
                },
                ruleB: {
                    userRealName: {required: true, message: '请输入联系人'},
                    tel: {required: true, message: '请输入联系电话'},
                    ps: {required: true, message: '请输入备注，若没有请输入无'}
                }
            }
        },
        mounted: function () {
            post('/common/get_my_info', {}, (data) => {
                userInfo = data[0];
            });
            post('/common/allwarehouse', {}, (data) => {
                for (let warehouse of data) {
                    app.warehouseChoice.push(warehouse);
                    for (let i = 0; i < 6; i++) {
                        app.warehouseChoiceList[i].push(warehouse);
                    }
                }
            });
        },
        methods: {
            viewTemp() {
                if (app.tempVisible === false) {
                    app.clearFilledForm();
                    while (app.resultData2[0] !== undefined) {
                        app.resultData2.pop();
                    }
                    post('/common/user_goods/get_saved_apply', {}, (data, err) => {
                        if (err) {
                            return;
                        }
                        for (let obj of data) {
                            app.resultData2.push(obj);
                        }
                    });
                    app.tempVisible = true;
                } else {
                    app.clearFilledForm();
                    while (app.resultData2[0] !== undefined) {
                        app.resultData2.pop();
                    }
                    app.tempVisible = false;
                }

            },
            clearFilledForm() {
                for (var key in app.singleForm) {
                    app.singleForm[key] = "";
                }
                for (var form_key in app.applicationForm) {
                    for (var key in app.applicationForm[form_key]) {
                        app.applicationForm[form_key][key] = "";
                    }
                }
                while (app.selectedLocations[0] != undefined) {
                    app.selectedLocations.pop();
                }
                for (var i in app.selectedLocationsList) {
                    app.selectedLocationsList[i] = [];
                }
                while (app.selectedTransport[0] != undefined) {
                    app.selectedTransport.pop();
                }
                while (app.selectedExpectTime[0] != undefined) {
                    app.selectedExpectTime.pop();
                }
                while (app.selectedWarehouse[0] != undefined) {
                    app.selectedWarehouse.pop();
                }
            },
            detail(row) {
                var tmp = [];
                while (app.detailForm[0] !== undefined) {
                    app.detailForm.pop();
                }
                post('/common/user_goods/get_detail', {
                    goodsId: row.goodsId
                }, (data, err) => {
                    if (err) {
                        app.$message.error(err.msg);
                    }
                    console.log(data);
                    for (var key in data) {
                        var obj = {};
                        obj['key'] = app.transfer[key];
                        if (key === 'is_managed') {
                            obj['val'] = ['不受监管', '受监管'][parseInt(data[key])];
                        } else if (key === 'state_id') {
                            obj['val'] = ["", '占用', '调配', '使用', '空闲'][parseInt(data[key])];
                        } else if (key === 'province_id' || key === 'city_id' || key === 'county_id') {
                            obj['val'] = CTT[parseInt(data[key])];
                        } else if (key === 'country_id') {
                            obj['val'] = ["其他", "中国", "其他"][parseInt(data[key])];
                        } else if (key === 'warehouse_id') {
                            obj['val'] = row.warehouseName;
                        } else {
                            obj['val'] = data[key];
                        }
                        if (obj['key'] !== undefined) {
                            tmp.push(obj);
                        }
                    }
                    for (let i = 0; tmp[i] !== undefined; i += 3) {
                        var obj = {};
                        obj['key1'] = tmp[i]['key'];
                        obj['val1'] = tmp[i]['val'];
                        if (tmp[i + 1]) {
                            obj['key2'] = tmp[i + 1]['key'];
                            obj['val2'] = tmp[i + 1]['val'];
                        } else {
                            obj['key2'] = "";
                            obj['val2'] = "";
                        }
                        if (tmp[i + 2]) {
                            obj['key3'] = tmp[i + 2]['key'];
                            obj['val3'] = tmp[i + 2]['val'];
                        } else {
                            obj['key3'] = "";
                            obj['val3'] = "";
                        }
                        app.detailForm.push(obj);
                    }
                });
                app.dialogs.detail = true;
            },
            allocate(row, frtmp) {
                // post('/common/allwarehouse', {}, (data) => {
                //     for (let warehouse of data) {
                //         app.warehouseChoice.push(warehouse);
                //     }
                // });
                row.dialogVisible = true;
                currentRow = row;
                // app.singleForm = {...generalApplicationForm};
                Object.assign(app.singleForm, generalApplicationForm)
                app.singleForm.userRealName = userInfo.realName;
                app.singleForm.companyName = userInfo.companyName;
                app.singleForm.goodId = row.goodsId;
                app.singleForm.goodName = row.goodsName;
                app.singleForm.startWarehouseName = row.warehouseName;
                if (frtmp === 'frtmp') {
                    [
                        app.singleForm.time,
                        app.singleForm.startWarehouseId,
                        app.singleForm.startWarehouseName,
                        app.singleForm.description,
                        app.singleForm.amount,
                        app.singleForm.transport,
                        app.singleForm.expectTime,
                        app.selectedLocations,
                        app.singleForm.destinationAddress,
                        app.singleForm.endWarehouseName,
                        app.singleForm.tel,
                        app.singleForm.ps,
                        app.singleForm.userRealName
                    ] = [
                        Number({'普通': 20, '应急': 4}[row.requestType]) * 4.5,
                        row.startWarehouseId,
                        row.startWarehouseName,
                        row.description,
                        row.amount,
                        row.requestType,
                        row.expectTime,
                        [row.destinationProvince, row.destinationCity],
                        row.destinationAddress,
                        row.endWarehouseName,
                        row.contractTel,
                        row.note,
                        row.contractPerson
                    ]
                }
            },
            allocateAll(frtmp) {
                if (app.multipleSelection.length <= 0) {
                    app.$message.error('没有选择任何条目');
                    return;
                }
                app.dialogs.allocateAll = true;
                // app.singleForm = {...generalApplicationForm};
                Object.assign(app.singleForm, generalApplicationForm);
                app.singleForm.userRealName = userInfo.realName;
                app.singleForm.companyName = userInfo.companyName;
                for (var choice in app.multipleSelection) {
                    // app.applicationForm[choice] = {...generalApplicationForm};
                    Object.assign(app.applicationForm[choice], generalApplicationForm);
                    app.applicationForm[choice].goodId = app.multipleSelection[choice].goodsId;
                    app.applicationForm[choice].goodName = app.multipleSelection[choice].goodsName;
                    app.applicationForm[choice].startWarehouseName = app.multipleSelection[choice].warehouseName;
                }
            },
            handleCurrentChange(page) {
                app.pageNum = page;
                searchKey['pageNum'] = app.pageNum;
                getData(searchKey);
            },
            handleChange(value) {
                app.locationRadio = "";
                console.log(value);
            },
            indexMethod(index) {
                return index + 1;
            },
            handleSelectionChange(val) {
                app.multipleSelection = val;
            },
            handleSelectionChange2(val) {
                app.multipleSelection2 = val;
            },
            search: function () {
                var data = {
                    stateId: app.stateId,
                    type: app.type,
                    province: app.selectedLocations[0],
                    city: app.selectedLocations[1],
                    produceTime: app.produceTime+' 00:00:00'
                };
                searchKey['pageNum'] = 1;
                app.pageNum = 1;
                for (var i in data) {
                    if (data[i] !== null && data[i] !== "") {
                        if (i === 'produceTime') {
                            searchKey[i] = data[i] + " 00:00:00";
                        }
                        searchKey[i] = data[i];
                    }
                }
                getData(searchKey);
            },
            reset: function () {
                searchKey = {pageNum: app.pageNum};
                app.stateId = "";
                app.type = "";
                app.selectedLocations = [];
                app.locationRadio = "";
                app.produceTime = "";
                getData(searchKey);
            },
            submitSingle: function (row, tmp, frtmp) {
                let promise = new Promise((resolve, reject) => {
                    let total = 0, real = 0;
                    for (let index = 1; index <= 5; index++) {
                        ((i) => {
                            app.$refs['form' + i].validate((valid) => {
                                total++;
                                if (valid) {
                                    real++;
                                }
                                if (total !== real) {
                                    app.$message.error('信息填写错误，请重新填写');
                                    reject();
                                    return false;
                                }
                            })
                        })(index);
                    }
                    resolve();
                });
                if (frtmp !== 'frtmp') {
                    promise.then(() => {
                        var toPost = {};
                        [
                            toPost['goodsId'],
                            toPost['description'],
                            toPost['amount'],
                            toPost['endWarehouseName'],
                            toPost['endWarehouseId'],
                            toPost['applyTime'],
                            toPost['destinationProvince'],
                            toPost['destinationCity'],
                            toPost['destinationAddress'],
                            toPost['requestType'],
                            toPost['expectTime'],
                            toPost['validTime'],
                            toPost['contractPerson'],
                            toPost['contractTel'],
                            toPost['note'],
                            toPost['isSubmit']
                        ] = [
                            app.singleForm['goodId'],
                            app.singleForm['description'],
                            parseInt(app.singleForm['amount']),
                            app.singleForm['endWarehouseName'],
                            (() => {
                                for (let i of app.warehouseChoice) {
                                    if (i.warehouseName === app.singleForm['endWarehouseName']) {
                                        return i.warehouseId;
                                    }
                                }
                            })(),
                            (() => {
                                var day = new Date();
                                var [year, month, date] = [day.getFullYear(), day.getMonth() + 1, day.getDate()];
                                if (month < 10) {
                                    month = '0' + month;
                                }
                                if (date < 10) {
                                    date = '0' + date;
                                }
                                return [year, month, date].join('-');
                            })(),
                            app.selectedLocations[0],
                            app.selectedLocations[1],
                            app.singleForm['destinationAddress'],
                            {'20': '应急', '4': '普通'}[String(app.singleForm['transport'])],
                            app.singleForm['expectTime'],
                            7,
                            app.singleForm['userRealName'],
                            app.singleForm['tel'],
                            app.singleForm['ps'],
                            tmp === 'temp' ? 0 : 1
                        ]
                        console.log(toPost);
                        post('/common/user_goods/submit', toPost, (data, err) => {
                            if (err) {
                                app.$message.error(err.msg);
                                return;
                            }
                            currentRow.dialogVisible = false;
                            app.$message({
                                type: 'success',
                                message: tmp === 'temp' ? '暂存成功' : '申请提交成功'
                            });
                        });
                    });
                } else {
                    promise.then(() => {
                        var toPost = {};
                        [
                            toPost['scheduleId'],
                            toPost['description'],
                            toPost['amount'],
                            toPost['endWarehouseId'],
                            toPost['endWarehouseName'],
                            toPost['applyTime'],
                            toPost['destinationProvince'],
                            toPost['destinationCity'],
                            toPost['destinationAddress'],
                            toPost['requestType'],
                            toPost['expectTime'],
                            toPost['validTime'],
                            toPost['contractPerson'],
                            toPost['contractTel'],
                            toPost['note'],
                            toPost['isSubmit']
                        ] = [
                            row.schedule_id,
                            app.singleForm.description,
                            app.singleForm.amount,
                            (() => {
                                for (var warehouse of app.warehouseChoice) {
                                    if (warehouse.warehouseName === app.singleForm.endWarehouseName) {
                                        return warehouse.warehouseId;
                                    }
                                }
                            })(),
                            app.singleForm.endWarehouseName,
                            row.applyTime,
                            app.selectedLocations[0],
                            app.selectedLocations[1],
                            app.singleForm.destinationAddress,
                            app.singleForm.transport,
                            app.singleForm.expectTime,
                            row.validTime,
                            app.singleForm.userRealName,
                            app.singleForm.tel,
                            app.singleForm.ps,
                            tmp === 'temp' ? 0 : 1
                        ];
                        post('/common/user_goods/update_apply', toPost, (data, err) => {
                            if (err) {
                                app.$message.error(err.msg);
                                return;
                            }
                            currentRow.dialogVisible = false;
                            app.clearFilledForm();
                            app.$message({
                                type: 'success',
                                message: tmp === 'temp' ? '暂存成功' : '申请提交成功'
                            });
                            app.viewTemp();
                            app.viewTemp();
                        });
                    })
                }
            },
            submitAll: function (tmp, frtmp) {
                var toPost = {};
                var postList = [];
                for (var form in app.applicationForm) {
                    if (app.selectedWarehouse[form]) {
                        if (frtmp !== 'frtmp') {
                            [
                                toPost['goodsId'],
                                toPost['description'],
                                toPost['amount'],
                                toPost['endWarehouseId'],
                                toPost['endWarehouseName'],
                                toPost['applyTime'],
                                toPost['destinationProvince'],
                                toPost['destinationCity'],
                                toPost['destinationAddress'],
                                toPost['requestType'],
                                toPost['expectTime'],
                                toPost['validTime'],
                                toPost['contractPerson'],
                                toPost['contractTel'],
                                toPost['note'],
                                toPost['isSubmit']
                            ] = [
                                app.applicationForm[form]['goodId'],
                                app.applicationForm[form]['description'],
                                parseInt(app.applicationForm[form]['amount']),
                                app.selectedWarehouse[form],
                                (() => {
                                    for (let i of app.warehouseChoiceList[form]) {
                                        if (i.warehouseId === app.selectedWarehouse[form]) {
                                            return i.warehouseName;
                                        }
                                    }
                                })(),
                                (() => {
                                    var day = new Date();
                                    var [year, month, date] = [day.getFullYear(), day.getMonth() + 1, day.getDate()];
                                    if (month < 10) {
                                        month = '0' + month;
                                    }
                                    if (date < 10) {
                                        date = '0' + date;
                                    }
                                    return [year, month, date].join('-');
                                })(),
                                app.selectedLocationsList[form][0],
                                app.selectedLocationsList[form][1],
                                app.applicationForm[form]['destinationAddress'],
                                {"20": "应急", "4": "普通"}[String(app.selectedTransport[form])],
                                app.selectedExpectTime[form],
                                7,
                                app.singleForm['userRealName'],
                                app.singleForm['tel'],
                                app.singleForm['ps'],
                                tmp === 'temp' ? 0 : 1
                            ];
                            ((d) => {
                                post('/common/user_goods/submit', d, (data, err) => {
                                    if (err) {
                                        app.$message.error(err.msg);
                                        return;
                                    }
                                    app.dialogs.allocateAll = false;
                                    app.$message({
                                        type: 'success',
                                        message: '申请提交成功'
                                    });
                                });
                            })((() => {
                                var obj = {};
                                Object.assign(obj, toPost);
                                return obj;
                            })());
                        } else {
                            [
                                toPost['scheduleId'],
                                toPost['description'],
                                toPost['amount'],
                                toPost['endWarehouseId'],
                                toPost['endWarehouseName'],
                                toPost['applyTime'],
                                toPost['destinationProvince'],
                                toPost['destinationCity'],
                                toPost['destinationAddress'],
                                toPost['requestType'],
                                toPost['expectTime'],
                                toPost['validTime'],
                                toPost['contractPerson'],
                                toPost['contractTel'],
                                toPost['note'],
                                toPost['isSubmit']
                            ] = [
                                app.resultData2[form].schedule_id,
                                app.applicationForm[form].description,
                                app.applicationForm[form].amount,
                                (() => {
                                    for (var warehouse of app.warehouseChoice) {
                                        if (warehouse.warehouseName === app.applicationForm[form].endWarehouseName) {
                                            return warehouse.warehouseId;
                                        }
                                    }
                                })(),
                                app.applicationForm[form].endWarehouseName,
                                app.resultData2[form].applyTime,
                                app.selectedLocations[0],
                                app.selectedLocations[1],
                                app.applicationForm[form].destinationAddress,
                                app.applicationForm[form].transport,
                                app.applicationForm[form].expectTime,
                                app.resultData2[form].validTime,
                                app.applicationForm[form].userRealName,
                                app.applicationForm[form].tel,
                                app.applicationForm[form].ps,
                                tmp === 'temp' ? 0 : 1
                            ];
                            app.resultData2[form]
                            ((d) => {
                                post('/common/user_goods/update_apply', d, (data, err) => {
                                    if (err) {
                                        app.$message.error(err.msg);
                                        return;
                                    }
                                    app.dialogs.allocateAll = false;
                                    app.clearFilledForm();
                                    app.$message({
                                        type: 'success',
                                        message: tmp === 'temp' ? '暂存成功' : '申请提交成功'
                                    });
                                    app.viewTemp();
                                    app.viewTemp();
                                });
                            })((() => {
                                var obj = {};
                                Object.assign(obj, toPost);
                                return obj;
                            })());
                        }
                    }
                }

            }
        }
    });
</script>
</html>