<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>出库登记</title>
    <link rel="stylesheet" href="lib/eleme-index.css">
    <link rel="stylesheet" href="res/print-form.css">
    <style>
        .el-form-item {
            margin: 0;
        }

        [v-cloak] {
            display: none;
        }

        .el-card {
            margin-bottom: 5px;
        }

        p.form-item {
            margin: 2px 0 5px;
        }

        .el-table {
            height: 750px;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <!--出库业务-->
    <div v-show="state!==3">
    <el-card v-loading.fullscreen="loading" element-loading-text="加载中" :rules="queryRules" element-loading-background="rgba(0,0,0,0.7)">
        <span slot="header">出库单填写</span>
        <el-form :model="outGoing" inline>
            <p class="form-item">
                <el-form-item label="操作员：" size="mini">
                    <el-input v-model="outGoing.realName" :disabled="true"></el-input>
                </el-form-item>
                <el-form-item label="仓库：" size="mini">
                    <el-input v-model="outGoing.warehouseName" :disabled="true"></el-input>
                </el-form-item>
            </p>
            <p class="form-item">
                <el-form-item label="建单人：" size="mini">
                    <el-input v-model="outGoing.founder"></el-input>
                </el-form-item>
                <el-form-item label="建单日期：" size="mini">
                    <el-date-picker v-model="outGoing.createTime" type="date"
                                    format="yyyy年MM月dd日"
                                    value-format="yyyy-MM-dd" :disabled="true"></el-date-picker>
                </el-form-item>
            </p>
            <p class="form-item">
                <el-form-item label="出库单号：" size="mini">
                    <el-input v-model="outGoing.inboundNum" :disabled="true"></el-input>
                </el-form-item>
                <el-form-item label="出库类别：" size="mini">
                    <el-select v-model="outGoing.type">
                        <el-option label="正常出库" value="1"></el-option>
                    </el-select>
                </el-form-item>
            </p>
        </el-form>
        <hr style="height:1px; border:none; border-top:1px dashed #c0c4cc">
        <p class="form-item">
            <el-table :data="outResult.slice((pageNum0-1)*6,pageNum0*6)" size="mini" max-height="250">
                <el-table-column type="index" width="44" label="序号"></el-table-column>
                <el-table-column prop="localId" label="货品编号"></el-table-column>
                <el-table-column prop="goodsName" label="货品名称"></el-table-column>
                <el-table-column prop="unit" label="单位"></el-table-column>
                <!--可编辑项 begin-->
                <el-table-column prop="amount" label="出库数量" width="75">
                    <template slot-scope="scope">
                        <el-input size="mini" v-model="scope.row.amount"></el-input>
                    </template>
                </el-table-column>
                <el-table-column prop="inboundTime" label="出库时间" width="200">
                    <template slot-scope="scope">
                        <el-date-picker v-model="scope.row.inboundTime" type="date"
                                        format="yyyy年MM月dd日" style="width:150px;"
                                        value-format="yyyy-MM-dd" size="mini"></el-date-picker>
                    </template>
                </el-table-column>

                <!--<el-table-column prop="endWarehouseName" label="去向">&lt;!&ndash;!!!!!去向要求下拉框 调用所有仓库按钮  待办&ndash;&gt;-->
                    <!--<template slot-scope="scope">-->
                    <!--</template>-->
                <!--</el-table-column>-->
                <!--可编辑项 end-->
                <el-table-column prop="charity" label="责任人"></el-table-column>
                <el-table-column prop="phone" label="联系电话"></el-table-column>
                <el-table-column prop="remark" label="备注"></el-table-column>
                <el-table-column>
                    <!--点击删除当前已选中货品-->
                    <template slot-scope="scope">
                        <el-button size="mini" style="background-color: #ececec"
                                   @click.native.prevent="deleteRow(scope.row)">删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination @current-change="handleCurrentChange0" :current-page="pageNum0"
                           :page-size="6" layout="total,prev,pager,next,jumper"
                           :total="outResult.length"></el-pagination>
        </p>
        <p class="form-item">
            <!--保存 生成货品清单-->
            <el-button style="background-color: #ececec" @click="save" size="mini">保存</el-button>
            <!--点击调用打印机 打印outResult表格清单-->
            <el-button style="background-color: #ececec" size="mini" @click="handlePrint">生成货品清单</el-button>
        </p>
    </el-card>

    <!--查找-->
    <el-card>
        <span slot="header">选择用来填写的物品</span>
        <el-form :model="queryCondition" inline>
            <p class="form-item">
                <!-- TODO: 放入组件 -->
                <el-form-item label="货品类别">
                    <el-ext-foldable :options="resTypeList" v-model="queryCondition.type"></el-ext-foldable>
                </el-form-item>
            </p>
            <p class="form-item">
                <el-form-item label="货品名称：" size="mini"><el-input v-model="queryCondition.goodsName"></el-input></el-form-item>
                <el-form-item label="供应商：" size="mini">
                    <el-input v-model="queryCondition.producerName"></el-input>
                </el-form-item>
            </p>
            <p class="form-item">
                <el-form-item label="货品编号：" size="mini">
                    <el-input v-model="queryCondition.localId"></el-input>
                </el-form-item>
            </p>
            <p class="form-item">
                <el-form-item size="mini">
                    <el-button style="background-color: #ececec" @click="search">查找</el-button>
                </el-form-item>
            </p>
            <hr style="height:1px; border:none; border-top:1px dashed #c0c4cc">

            <p class="form-item">
                <el-table :data="queryResult" size="mini" max-height="250">
                    <el-table-column type="index" width="50" label="序号"></el-table-column>
                    <el-table-column prop="localId" label="货品编号"></el-table-column>
                    <el-table-column prop="goodsName" label="货品名称"></el-table-column>
                    <el-table-column prop="applicationNum" label="申请单号"></el-table-column>
                    <el-table-column prop="supplier" label="供应商"></el-table-column>
                    <el-table-column label="详细信息" width="80">
                        <!--点击查看当前物资详细信息-->
                        <template slot-scope="scope">
                            <el-button size="mini" style="background-color: #ececec" @click="viewDetail(scope.row)">查看
                            </el-button>
                        </template>
                    </el-table-column>
                    <el-table-column prop="charity" label="责任人"></el-table-column>
                    <el-table-column prop="phone" label="联系电话"></el-table-column>
                    <el-table-column prop="ruku" label="">
                        <!--点击出库 复制转移所有当前货品编号至 outResult-->
                        <template slot-scope="scope">
                            <el-button size="mini" style="background-color: #ececec" @click="goOut(scope.row)"
                                       :disabled="scope.row.isOut">出库
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <el-pagination @current-change="handleCurrentChange" :current-page="pageNum"
                               :page-size="pageSize" layout="total,prev,pager,next,jumper"
                               :total="total[0]"></el-pagination>
                <el-dialog title="货品详细信息" :visible.sync="dialogVisible" width="95%"
                           :before-close="handleClose">
                    <el-table :data="detailForm">
                        <el-table-column prop="key1" :width="150">
                            <template slot-scope="props">
                                <b>{{props.row.key1}}</b>
                            </template>
                        </el-table-column>
                        <el-table-column prop="val1" :width="200">
                            <template slot-scope="props">
                                <span>{{props.row.val1}}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="key2" :width="150">
                            <template slot-scope="props">
                                <b>{{props.row.key2}}</b>
                            </template>
                        </el-table-column>

                        <el-table-column prop="val2" :width="200">
                            <template slot-scope="props">
                                <span>{{props.row.val2}}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="key3" :width="150">
                            <template slot-scope="props">
                                <b>{{props.row.key3}}</b>
                            </template>
                        </el-table-column>

                        <el-table-column prop="val3" :width="200">
                            <template slot-scope="props">
                                <span>{{props.row.val3}}</span>
                            </template>
                        </el-table-column>
                    </el-table>
                    <span slot="footer" class="dialog-footer">
                                <el-button @click="dialogVisible = false" size="mini" style="background-color: #ececec">关闭</el-button>
                            </span>
                </el-dialog>
            </p>
        </el-form>
    </el-card>
    </div>
    <div v-show="state===3" id="box3">
        <!--startprint-->
        <p id="form-top">
            <span><b>出库单号:</b>{{outGoing.inboundNum}}</span>
            <span><b>出库类别:</b>{{outGoing.type}}</span>
            <span><b>供应商:</b>{{outGoing.supplier}}</span>
            <span><b>操作员:</b>{{outGoing.operator}}</span>
            <span><b>建单人:</b>{{outGoing.founder}}</span>
            <span><b>建单日期:</b>{{(()=>{
                var da=new Date();
                var [year,month,date]=[da.getFullYear(),da.getMonth()+1,da.getDate()];
                return year+'年'+month+'月'+date+'日';
                })()}}</span>
        </p>
        <table class="grid">
            <tr>
                <th>序号</th>
                <th>物资名称</th>
                <th>身份识别码</th>
                <th>出库时间</th>
                <th>数量</th>
                <th>供应商</th>
                <th>目的仓库</th>
                <th>负责人</th>
                <th>联系电话</th>
                <th>备注</th>
            </tr>
            <tr v-for="data in toPrint">
                <td v-for="key in Object.keys(data)">{{data[key]}}</td>
            </tr>
        </table>
        <!--endprint-->
        <p class="noprint">
            <el-button type="primary" @click="performPrint">打印</el-button>
            <el-button @click="()=>{state=1;}">返回</el-button>
        </p>
    </div>
</div>
</body>
<script src="lib/vue.js"></script>
<script src="lib/eleme-index.js"></script>
<script src="res/dependencies.js"></script>
<script>
    const CTT = require('element-china-area-data').CodeToText;
    const ElExtFoldable = require('/comps/el-ext-foldable');
    var post=require('/mods/backend');

    var catchData = require('/mods/pagination').getData;

    var totalPages = [0,];
    function getData(app){
        post('/depot/initialize',{},(data,err)=>{
            if(err){
                app.loading=false;
                return;
            }
            app.outGoing.realName=data.realName;
            app.outGoing.warehouseName=data.warehouseName;
            app.loading=false;
        })
    }

    function queryFor(app) {
        catchData({
            url: '/depot/query_schedule',
            app: app,
            refresh: [app.queryResult,],
            searchKey: (() => {
                var obj = {};
                Object.assign(obj, app.queryCondition, {method: '出库'});
                if (!obj.type[0]) {
                    delete obj.type;
                }
                return obj;
            })(),
            pageNum: app.pageNum,
            pageSize: app.pageSize,
            itemName: 'views',
            total: (totalNum) => {
                while (totalPages[0] !== undefined) {
                    totalPages.pop();
                }
                totalPages.push(totalNum);
            }
        }, (allPages, data) => {
            for (var item of data) {
                item['isOut'] = false;
                app.queryResult.push(item);
            }
        },10)
    }

    var app = new Vue({
        el: '#app',
        data: function(){
            return{
                loading:true,
                state:0,
                toPrint:[],
                detailForm:[],
                pageNum0: 1,
                pageSize: 6,
                pageNum: 1,
                total: totalPages,
                resTypeList: [
                    '电脑整机', '大型家电', '网络产品', '厨房电器',
                    '电脑配件', '五金装饰', '摄影摄像', '健康卫生',
                    '数码配件', '通信器材', '办公设备', '家具',
                    '文具耗材', '生活电器', '生活用品', '汽车用品',
                    '文体器材', '学习书籍', '粮油食品', '工程建材',
                    '医疗卫生', '油品', '军队服装', '交通工具', '其他'
                ],
                queryCondition: {/* 查找部分 —— 查找条件 */
                    goodsName: '',
                    producerName: '',
                    localId: '',
                    type: []
                },
                transfer: {
                    goods_id: '物资ID',
                    goods_name: '物资名称',
                    local_id: '编号',
                    type: '物资类型',
                    keywords: '关键字',
                    norms: '规格',
                    appearance: '外观',
                    time_feature: '时间特征',
                    safety_condition: '安全条件',
                    carrier_size: '运载尺寸',
                    temperature: '温度条件',
                    humidity: '湿度条件',
                    other_conditions: '其他条件',
                    producer_name: '生产商',
                    produce_time: '生产时间',
                    produce_valid_time: '过期时间',
                    warehouse_id: '所在仓库',
                    longitude: '经度',
                    latitude: '纬度',
                    altitude: '海拔',
                    country_id: '国家',
                    area: '战区',
                    province_id: '省份',
                    city_id: '城市',
                    county_id: '区县',
                    detail_location: '详细地址',
                    is_managed: '过程管理',
                    register_time: '最后一次修改时间',
                    state_id: '状态',
                    state_type: '状态类型',
                    state_value: '状态值',
                    quantity: '数量'
                },
                queryResult: [],
                outGoing:{/* 出库业务 —— 相关信息填写  (搞定)*/
                    warehouseName:'',
                    realName:'',
                    founder:'',
                    createTime: (() => {
                        var today = new Date();
                        var yyyy = today.getFullYear();
                        var mm = today.getMonth() + 1 < 10 ? ('0' + (today.getMonth() + 1)) : (today.getMonth() + 1);
                        var dd = today.getDate() < 10 ? ('0' + today.getDate()) : (today.getDate());
                        return yyyy + '-' + mm + '-' + dd;
                    })(),
                    inboundNum: (() => {
                        let da = new Date();
                        let postfix = String(Date.parse(da)).slice(4, 10);
                        let [year, month, date] = [
                            da.getFullYear(),
                            da.getMonth() + 1 < 10 ? '0' + (da.getMonth() + 1) : da.getMonth() + 1,
                            da.getDate() < 10 ? '0' + da.getDate() : da.getDate()
                        ];
                        return [year, month, date].join('') + '2' + postfix;
                    })(),
                    type:''
                },
                outResult:[],
                fileList: [{/* 出库业务 —— 出库单上传 */
                    name: '默认文件',
                    url: ''
                }],

                dialogVisible:false  /*查看当前货品详细信息 查看 button*/

            }
        },
        mounted(){
            getData(this);
        },
        methods: {
            performPrint(){
                window.print();
            },
            handlePrint(){
                app.toPrint = [];
                var obj = {
                    index: 1,
                    goodsName: "",
                    localId: "",
                    inboundTime:"",
                    amount: "",
                    supplier: "",
                    endWarehouseName: "",
                    charity: "",
                    phone: "",
                    remark: ""
                };
                var standard_keys=Object.keys(obj);
                for (let i in app.outResult) {
                    Object.assign(obj, app.outResult[i]);
                    obj.index = parseInt(i) + 1;
                    for(var key in obj){
                        if(standard_keys.indexOf(key)===-1)
                            delete obj[key];
                    }
                    var obj2={};
                    Object.assign(obj2,obj);
                    app.toPrint.push(obj2);
                }
                app.state = 3;
            },
            save() {
                var newList=[];
                post('/depot/storage_management', {
                    method: '出库',
                    inboundNum: app.outGoing.inboundNum,
                    founder: app.outGoing.founder,
                    createTime:app.outGoing.createTime+' 00:00:00',
                    list: (() => {
                        newList = [];
                        for (var item of app.outResult) {
                            var obj = {};
                            Object.assign(obj, {
                                scheduleId: item.scheduleId,
                                amount: item.amount,
                                inboundTime:Date.parse(item.inboundTime)
                            });
                            newList.push(obj);
                        }
                        return newList;
                    })()
                }, (data, err) => {
                    if (err) {
                        return;
                    }
                    app.$message.success('出库登记成功');
                    while(app.outResult[0]!==undefined){
                        app.outResult.pop();
                    }
                    app.pageNum=1;
                    app.outGoing.founder='';
                    app.outGoing.inboundNum=generate_num();
                    app.outGoing.createTime=generate_created_time();
                    queryFor(app);
                })
            },
            viewDetail(row) {
                while (app.detailForm[0] !== undefined) {
                    app.detailForm.pop();
                }
                var tmp = [];
                post('/depot/get_detail', {
                    goodsId: row.goodsId,
                    goodsLocalId: row.goodsLocalId
                }, (data, err) => {
                    if (err) {
                        return;
                    }
                    for (var key in data) {
                        var obj = {};
                        obj['key'] = app.transfer[key];
                        if (key === 'is_managed') {
                            obj['val'] = ['不受监管', '受监管'][parseInt(data[key])];
                        } else if (key === 'state_id') {
                            obj['val'] = ["", '占用', '调配', '使用', '空闲'][parseInt(data[key])];
                        } else if (key === 'province_id' || key === 'city_id' || key === 'county_id') {
                            obj['val'] = CTT[parseInt(data[key])];
                        } else if (key === 'country_id') {
                            obj['val'] = ["其他", "中国", "其他"][parseInt(data[key])];
                        } else if (key === 'warehouse_id') {
                            obj['val'] = row.warehouseName;
                        } else {
                            obj['val'] = data[key];
                        }
                        if (obj['key'] !== undefined) {
                            tmp.push(obj);
                        }
                    }
                    for (let i = 0; tmp[i] !== undefined; i += 3) {
                        var obj = {};
                        obj['key1'] = tmp[i]['key'];
                        obj['val1'] = tmp[i]['val'];
                        if (tmp[i + 1]) {
                            obj['key2'] = tmp[i + 1]['key'];
                            obj['val2'] = tmp[i + 1]['val'];
                        } else {
                            obj['key2'] = "";
                            obj['val2'] = "";
                        }
                        if (tmp[i + 2]) {
                            obj['key3'] = tmp[i + 2]['key'];
                            obj['val3'] = tmp[i + 2]['val'];
                        } else {
                            obj['key3'] = "";
                            obj['val3'] = "";
                        }
                        app.detailForm.push(obj);
                    }
                });
                app.dialogVisible = true;
            },
            handleClose() {
                app.dialogVisible = false;
            },
            handleCurrentChange0(page) {
                app.pageNum0 = page;
            },
            handleCurrentChange(page){
                app.pageNum=page;
                queryFor(app);
            },
            goOut(row){
                app.outResult.push(row);
                row.isOut = true;
            },
            search(){
                app.pageNum = 1;
                queryFor(app);
            },
            /*出库单上传相关函数 begin*/
            handleRemove(file, fileList) {
                console.log(file, fileList);
            },
            handlePreview(file) {
                console.log(file);
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                return this.$confirm(`确定移除 ${ file.name }？`);
            },
            /*出库单上传相关函数 end*/

            /*表格内 删除 按钮  begin*/
            deleteRow(row) {
                app.outResult.splice(app.outResult.indexOf(row), 1);
                row.isOut = false;
            }
        },
        components: {
            ElExtFoldable: ElExtFoldable
        }
    });
</script>

</html>